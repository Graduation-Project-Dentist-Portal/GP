@page
@model DentistPortal_Client.Pages.DoctorPages.DisplayMedicalCasesModel
@using System.Drawing
@using DentistPortal_Client.DTO
@using System.Text.Json
@using Microsoft.Extensions.Configuration
@using System.Net.Http
@using Microsoft.Extensions.DependencyInjection;
@using Microsoft.AspNetCore.Http;
@using System.IdentityModel.Tokens.Jwt
@section styles{
    <link rel="stylesheet" href="~/css/MedicalCaseStyleSheet.css">
    }
<header style="position: relative;padding-top: 48px;">
        <div class="website-search">
            <form id="live-search" action="" method="post">
                <div>
                    <input type="text" placeholder="Search" class="text" id="diagnosisInput">
                </div>
            </form>
            <div class="menu-main-menu">
                <ul id="menu-main-menu" class="menu">
                    <li id="menu-item-680"
                    class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-680">
                        <a href="../MedicalCases/MyMedicalCases"> My Cases </a> </li> </ul>
                    </div>
                    </div>
    </header>

    @{
    int counter = 0;
    IConfiguration config = new ConfigurationBuilder()
              .AddJsonFile("appsettings.json")
              .AddEnvironmentVariables()
              .Build();
    var httpClient = HttpContext.RequestServices.GetService<IHttpClientFactory>();
    if (HttpContext.Session.GetString("Token") == null)
    {
        Response.Redirect($"https://localhost:7156/Login?url={"DoctorPages/MedicalCases/DisplayMedicalCases"}");
    }
    else
    {
        var jwt = new JwtSecurityTokenHandler().ReadJwtToken(HttpContext.Session.GetString("Token"));
        var client = httpClient.CreateClient();
        client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", HttpContext.Session.GetString("Token"));
        client.BaseAddress = new Uri(config["BaseAddress"]);
        string req;
        List<string> imageUrls = new();
        <section class="cases">
            <div class="overlay"></div>
            <div class="container-fluid">
                <div class="row  gy-4">
                    <div class=" col-sm-5 ">
                        <div class="labla">

                            <div class=" paragraph">
                                <h4>Search to find the Case you Need .......</h4>
                                <p>
                                    These cases were found by junior dentists during their journey of looking for cases but were not compatible to their needs. So, they decided to add it in our website so that another junior student looking for a case with the same description could help them. By doing so, we will help both patient and junior dentist.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class=" col-sm-7">
                        <div class=" container medicalcase">
                            <div class="row justify-content-center gy-4">
                                <div class="col-sm justify-content-center">
                                    <div class="innerMedical filterfun">
                                        <div class="accordion" id="accordionExample ">

                                            @foreach (var medCase in Model.MedicalCases)
                                            {
                                                imageUrls = new();
                                                req = string.Empty;
                                                req = await client.GetStringAsync($"api/get-medical-case-pics/{medCase.Id}");
                                                if (req is not null)
                                                {
                                                    var options = new JsonSerializerOptions
                        {
                            WriteIndented = true,
                            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                            DictionaryKeyPolicy = JsonNamingPolicy.CamelCase
                        };
                                                    imageUrls = JsonSerializer.Deserialize<List<string>>(req, options);
                                                }
                                                <ul id="myList" class="" style="display:block;">
                                                    <li style="width:100%">
                                                        <div class="myaccordion ">

                                                            <div class="accordion-item">

                                                                <h2 class="accordion-header" id=@("heading"+counter)>
                                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target=@("#collapse" + @counter) aria-controls=@("collapse"+@counter) aria-expanded="true">
                                                                        @medCase.Diagnosis
                                                                    </button>
                                                                </h2>

                                                                <div id=@("collapse"+@counter) class="accordion-collapse collapse" aria-labelledby=@("heading"+@counter) data-bs-parent="#accordionExample">
                                                                    <div class="accordion-body">
                                                                        <div class="card mycard">
                                                                            <div class="row no-gutters">
                                                                                <div class="col-sm-5">
                                                                                    <div class="imgdiv" style="width:100%;">
                                                                                        <div id=@("carouselExampleControls"+@counter) class="carousel slide" data-bs-ride="carousel">
                                                                                            <div class="carousel-inner text-center">
                                                                                                @foreach (var item in imageUrls)
                                                                                                {
                                                                                                    if (item == imageUrls[0])
                                                                                                    {
                                                                                                        <div class="carousel-item active">
                                                                                                            <img src=@item alt="..." class="d-block w-100" />
                                                                                                        </div>
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        <div class="carousel-item">
                                                                                                            <img src=@item alt="..." class="d-block w-100" />
                                                                                                        </div>
                                                                                                    }
                                                                                                }
                                                                                            </div>
                                                                                            <button class="carousel-control-prev" type="button" data-bs-target=@("#carouselExampleControls" + @counter) data-bs-slide="prev">
                                                                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                                                                <span class="visually-hidden">Previous</span>
                                                                                            </button>
                                                                                            <button class="carousel-control-next" type="button" data-bs-target=@("#carouselExampleControls" + @counter) data-bs-slide="next">
                                                                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                                                                <span class="visually-hidden">Next</span>
                                                                                            </button>
                                                                                        </div>

                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-sm-7">
                                                                                    <div class="card-body mycardbody">
                                                                                        <form asp-page-handler="TakeCase" asp-route-caseId="@medCase.Id" method="post">

                                                                                            @if (medCase.DoctorId == Model.DoctorId)
                                                                                            {
                                                                                                <div class="setting">
                                                                                                    <div class="dropdown">
                                                                                                        <button class="dropdown-toggle sett" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                                                            <i class="bi bi-three-dots-vertical"></i>
                                                                                                        </button>
                                                                                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">

                                                                                                            <!-- Button trigger delete modal -->
                                                                                                            <li style="display:block;"><button class="dropdown-item" data-bs-toggle="modal" data-bs-target=@("#deleteMedicalCaseModal" + @counter)>Delete</button></li>

                                                                                                            <!-- Button trigger edit modal -->
                                                                                                            <li style="display:block;"><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target=@("#editMedicalCaseModal" + @counter)>Edit</button></li>
                                                                                                        </ul>
                                                                                                    </div>
                                                                                                </div>
                                                                                            }
                                                                                        </form>
                                                                                        <p class="card-text">@medCase.Description</p>
                                                                                        <div class="d-flex flex-column justify-content-between align-items-center">

                                                                                            <form asp-page-handler="TakeCase" asp-route-caseId="@medCase.Id" method="post">
                                                                                                <button type="submit" class="btn mybtn">
                                                                                                    <i class="bi bi-person-heart"> Take Case</i>
                                                                                                </button>
                                                                                            </form>

                                                                                            <!-- Button trigger view modal -->
                                                                                            <button type="button" class="btn mybtn" data-bs-toggle="modal" data-bs-target=@("#viewMedicalCaseModal" + @counter)>
                                                                                                Patient Info
                                                                                            </button>

                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </li>
                                                </ul>

                                                <!-- View Modal -->
                                                <div class="modal fade" id=@("viewMedicalCaseModal"+@counter) tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="exampleModalLongTitle" style="color:black">Patient Info</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="details">
                                                                    <div class="PatientName">@medCase.PatientName</div>


                                                                    <div class="line">

                                                                        <div class="PatientPhone">
                                                                            <i class="fa-sharp fa-solid fa-phone"></i>
                                                                            <span> @medCase.PatientPhone</span>
                                                                        </div>
                                                                        <div class="PatientAge">

                                                                            <span>@medCase.PatientAge</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Edit MedicalCase Modal -->
                                                <div class="modal fade" id=@("editMedicalCaseModal"+counter) data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered modal-lg">
                                                        <div class="modal-content" style="top: 79px;">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="staticBackdropLabel" style="color:black">Edit Clinic</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body modal-lg">
                                                                <form method="post" enctype="multipart/form-data" class="align-content-center col-6 w-100 needs-validation" style="margin:auto;text-align:center;color:#1A2238;" novalidate>
                                                                    <input name="medicalCaseDto.DoctorId" value="@medCase.DoctorId" hidden>
                                                                    <input name="id" value="@medCase.Id" hidden>
                                                                    <div class="form-floating form-outline mb-2">
                                                                        <input name="medicalCaseDto.PatientName" class="form-control" id="floatingPatientName" placeholder="PatientName" value="@medCase.PatientName" required>
                                                                        <label class="form-label" for="floatingPatientName">Patient Name</label>
                                                                        <div class="invalid-feedback">
                                                                            Please fill the patient name.
                                                                        </div>
                                                                    </div>
                                                                    <div class="form-floating form-outline mb-1">
                                                                        <input name="medicalCaseDto.PatientPhone" class="form-control" id="floatingPatientPhone" placeholder="PatientPhone" value="@medCase.PatientPhone" required>
                                                                        <label class="form-label" for="floatingPatientPhone">Patient Phone</label>
                                                                        <div class="invalid-feedback">
                                                                            Please fill the patient phone.
                                                                        </div>
                                                                    </div>
                                                                    <div class="form-floating form-outline mb-1">
                                                                        <input name="medicalCaseDto.PatientAge" class="form-control" id="floatingPatientAge" placeholder="PatientAge" value="@medCase.PatientAge" required>
                                                                        <label class="form-label" for="floatingPatientAge">Pateint Age</label>
                                                                        <div class="invalid-feedback">
                                                                            Please fill the patient age.
                                                                        </div>
                                                                    </div>
                                                                    <div class="form-floating form-outline mb-1">
                                                                        <input name="medicalCaseDto.Diagnosis" class="form-control" id="floatingPatientDiagnosis" placeholder="PatientDiagnosis" value="@medCase.Diagnosis" required>
                                                                        <label class="form-label" for="floatingPatientDiagnosis">Diagnosis</label>
                                                                        <div class="invalid-feedback">
                                                                            Please fill the patient diagnosis.
                                                                        </div>
                                                                    </div>
                                                                    <div class="form-floating form-outline mb-1">
                                                                        <textarea name="medicalCaseDto.Description" class="form-control resize" rows="5" id="floatingPatientDescription" placeholder="PatientDesription" style="height: 114px;"
                                                                          required>@medCase.Description</textarea>
                                                                        <label class="form-label" for="floatingPatientDescription">Description</label>
                                                                        <div class="invalid-feedback">
                                                                            Please fill the patient case description.
                                                                        </div>
                                                                    </div>
                                                                    <div id=@("carouselEditControls"+counter) class="carousel slide" data-bs-ride="carousel">
                                                                        <div class="carousel-inner text-center">
                                                                            @foreach (var item in imageUrls)
                                                                            {
                                                                                if (item == imageUrls[0])
                                                                                {
                                                                                    <div class="carousel-item active">
                                                                                        <img src=@item alt="..." width="200" height="200" />
                                                                                    </div>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <div class="carousel-item">
                                                                                        <img src=@item alt="..." width="200" height="200" />
                                                                                    </div>
                                                                                }
                                                                            }
                                                                        </div>
                                                                        <button class="carousel-control-prev" type="button" data-bs-target=@("#carouselEditControls" + counter) data-bs-slide="prev">
                                                                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                                            <span class="visually-hidden">Previous</span>
                                                                        </button>
                                                                        <button class="carousel-control-next" type="button" data-bs-target=@("#carouselEditControls" + counter) data-bs-slide="next">
                                                                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                                            <span class="visually-hidden">Next</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="form-floating form-outline mb-2">
                                                                        <input name="medicalCaseDto.CasePictures" class="form-control" type="file" multiple>
                                                                        <label class="form-label">Upload new case pictures</label>
                                                                    </div>
                                                                    <button asp-page-handler="Edit" type="submit" class="btn btn-success btn-block mb-3"><i class="bi bi-pencil-square"> Edit</i></button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!--Delete MedicalCase-->
                                                <div class="modal fade" id=@("deleteMedicalCaseModal"+counter) tabindex="-1" aria-labelledby="deleteClinicModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body" style="text-align:center">
                                                                Are you sure?
                                                                <br />
                                                                You won't be able to revert this!
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                <form asp-page-handler="Delete" asp-route-id="@medCase.Id" method="post">
                                                                    <button type="submit" class="btn btn-danger" style="margin-right:125px" data-bs-dismiss="modal">Yes, delete it!</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                counter++;
                                            }
                                            @foreach (var patientCase in Model.PatientCases)
                                            {

                                                imageUrls = new();
                                                req = string.Empty;
                                                req = await client.GetStringAsync($"api/get-patient-case-pics/{patientCase.Id}");
                                                if (req is not null)
                                                {
                                                    var options = new JsonSerializerOptions
                        {
                            WriteIndented = true,
                            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                            DictionaryKeyPolicy = JsonNamingPolicy.CamelCase
                        };
                                                    imageUrls = JsonSerializer.Deserialize<List<string>>(req, options);
                                                }

                                                <ul id="myList" class="" style="display:block;">
                                                    <li class="w-100">
                                                        <div class="myaccordion ">

                                                            <div class="accordion-item">

                                                                <h2 class="accordion-header" id=@("heading"+counter)>
                                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target=@("#collapse" + @counter) aria-controls=@("collapse"+@counter) aria-expanded="true">
                                                                        Added By Patient
                                                                    </button>
                                                                </h2>

                                                                <div id=@("collapse"+@counter) class="accordion-collapse collapse" aria-labelledby=@("heading"+@counter) data-bs-parent="#accordionExample">
                                                                    <div class="accordion-body">





                                                                        <div class="card mycard">
                                                                            <div class="row no-gutters">



                                                                                <div class="col-sm-5">
                                                                                    <div class="imgdiv" style="width:100%;">
                                                                                        <div id=@("carouselExampleControls"+@counter) class="carousel slide" data-bs-ride="carousel">
                                                                                            <div class="carousel-inner text-center">
                                                                                                @foreach (var item in imageUrls)
                                                                                                {
                                                                                                    if (item == imageUrls[0])
                                                                                                    {
                                                                                                        <div class="carousel-item active">
                                                                                                            <img src=@item alt="..." class="card-img-top h-100" style="width:80%;" />
                                                                                                        </div>
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        <div class="carousel-item">
                                                                                                            <img src=@item alt="..." class="card-img-top h-100" style="width:80%;" />
                                                                                                        </div>
                                                                                                    }
                                                                                                }
                                                                                            </div>
                                                                                            <button class="carousel-control-prev" type="button" data-bs-target=@("#carouselExampleControls" + @counter) data-bs-slide="prev">
                                                                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                                                                <span class="visually-hidden">Previous</span>
                                                                                            </button>
                                                                                            <button class="carousel-control-next" type="button" data-bs-target=@("#carouselExampleControls" + @counter) data-bs-slide="next">
                                                                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                                                                <span class="visually-hidden">Next</span>
                                                                                            </button>
                                                                                        </div>

                                                                                    </div>
                                                                                </div>




                                                                                <div class="col-sm-7">
                                                                                    <div class="card-body mycardbody">

                                                                                        <div class="details">
                                                                                            <div class="PatientName">@patientCase.Patient.Username</div>
                                                                                            <div class="CaseDescription">
                                                                                                <br><b>Case description: </b>@patientCase.Description
                                                                                            </div>

                                                                                            <div class="line">

                                                                                                <div class="PatientPhone">
                                                                                                    <i class="fa-sharp fa-solid fa-phone"></i>
                                                                                                    <span> @patientCase.PatientPhone</span>
                                                                                                </div>
                                                                                                <div class="PatientAge">
                                                                                                <span>Age:</span>
                                                                                                    <span>@patientCase.PatientAge</span>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                        <form asp-page-handler="TakeCase" asp-route-caseId="@patientCase.Id" method="post">
                                                                                            <button type="submit" class="btn mybtn">
                                                                                                <i class="bi bi-person-heart"> Take Case</i>
                                                                                            </button>
                                                                                        </form>


                                            </div>
                                        </div>






                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                </li>

                </ul>



                                                counter++;


                                            }
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    }
}



<section class="addmodel text-center">
    <div class="text-center col-sm addcasebutton">
        <button type="button" class="btn mybtn" data-bs-toggle="modal" data-bs-target="#AddMedicalCase">
            <i class="bi bi-plus-circle" style="font-style:normal"> Add Medical Case</i>
        </button>
    </div>
    <div class="modal fade" id="AddMedicalCase" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel" style="color:black">Enter Patient Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-lg">
                    <form method="post" id="createMedicalCase" enctype="multipart/form-data"
                          class="align-content-center col-6 w-100 needs-validation" style="margin:auto;color:#1A2238;"
                          novalidate>
                        <div class="form-floating form-outline mb-2">
                            <input name="medicalCaseDto.PatientName" class="form-control" id="floatingPatientName"
                                   placeholder="PatientName" required>
                            <label class="form-label" for="floatingPatientName">Patient Name</label>
                            <div class="invalid-feedback">
                                Please fill the patient name.
                            </div>
                        </div>
                        <div class="form-floating form-outline mb-1">
                            <input name="medicalCaseDto.PatientPhone" class="form-control" id="floatingPatientPhone"
                                   placeholder="PatientPhone" required>
                            <label class="form-label" for="floatingPatientPhone">Patient Phone</label>
                            <div class="invalid-feedback">
                                Please fill the patient phone.
                            </div>
                        </div>
                        <div class="form-floating form-outline mb-1">
                            <input name="medicalCaseDto.PatientAge" class="form-control" id="floatingPatientAge"
                                   placeholder="PatientAge" required>
                            <label class="form-label" for="floatingPatientAge">Pateint Age</label>
                            <div class="invalid-feedback">
                                Please fill the patient age.
                            </div>
                        </div>
                        <div class="form-floating form-outline mb-1">
                            <input name="medicalCaseDto.Diagnosis" class="form-control" id="floatingPatientDiagnosis"
                                   placeholder="PatientDiagnosis" required>
                            <label class="form-label" for="floatingPatientDiagnosis">Diagnosis</label>
                            <div class="invalid-feedback">
                                Please fill the patient diagnosis.
                            </div>
                        </div>
                        <div class="form-floating form-outline mb-1">
                            <textarea name="medicalCaseDto.Description" class="form-control resize" rows="5"
                                      id="floatingPatientDescription" placeholder="PatientDesription" required></textarea>
                            <label class="form-label" for="floatingPatientDescription">Description</label>
                            <div class="invalid-feedback">
                                Please fill the patient case description.
                            </div>
                        </div>
                        <div class="form-floating form-outline mb-1">
                            <input name="medicalCaseDto.CasePictures" class="form-control" type="file"
                                   id="floatingPatientPictures" placeholder="PatientPictures" multiple required>
                            <label class="form-label" for="floatingPatientPictures">Upload Case Pictures</label>
                            <div class="invalid-feedback">
                                Please add the case pictures.
                            </div>
                        </div>
                        <div class="form-check form-outline mb-1">
                            <input class="form-check-input" type="checkbox" name="medicalCaseDto.AssignedToMe" value="true" style="display:block;">
                            <label class="form-check-label" style=" transform: translate(-291px, 0px);">
                                Assign Case to me
                            </label>
                        </div>
                        <div style="text-align:center">
                            <button type="submit" class="btn mybtn btn-block mb-3" style="width:120px;">
                                <i class="bi bi-patch-plus text-center" style="font-style:normal;"> Add</i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
@if (@Model.Msg != null)
{
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    if (@Model.Status == "success")
    {
        <script type="text/javascript">
            Swal.fire({
                icon: 'success',
                title: '@Model.Msg',
                showConfirmButton: false,
                timer: 1500
            })
        </script>
    }
    else if (@Model.Status == "error")
    {
        <script type="text/javascript">
            Swal.fire({
                icon: 'error',
                title: '@Model.Msg',
                showConfirmButton: true
            })
        </script>
    }
}





<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        $("#diagnosisInput").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#myList li").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
    });
</script>

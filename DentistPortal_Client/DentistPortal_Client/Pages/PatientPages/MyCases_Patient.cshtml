@page
@using System.Drawing
@using DentistPortal_Client.DTO
@using System.Text.Json
@using Microsoft.Extensions.Configuration
@using System.Net.Http
@using Microsoft.Extensions.DependencyInjection;
@using Microsoft.AspNetCore.Http;
@using System.IdentityModel.Tokens.Jwt
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@model DentistPortal_Client.Pages.PatientPages.MyCases_PatientModel

@section styles{
    <link rel="stylesheet" href="~/css/PatientCasesStyleSheet.css" />
}
@{
    int counter = 0;
    IConfiguration config = new ConfigurationBuilder()
              .AddJsonFile("appsettings.json")
              .AddEnvironmentVariables()
              .Build();
    var httpClient = HttpContext.RequestServices.GetService<IHttpClientFactory>();
    if (HttpContext.Session.GetString("Token") == null)
    {
        Response.Redirect($"https://localhost:7156/Login?url={"PatientPages/DisplayPatientCases"}");
    }
    else
    {
        var jwt = new JwtSecurityTokenHandler().ReadJwtToken(HttpContext.Session.GetString("Token"));
        var client = httpClient.CreateClient();
        client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", HttpContext.Session.GetString("Token"));
        client.BaseAddress = new Uri(config["BaseAddress"]);
        string req;
        List<string> imageUrls = new();
        <div class="container-fluid">
            <div class="row  gy-4">
                <div class=" col-sm-4 text-center">
                    <div class="labla">

                        <div class=" paragraph">
                            <h4>Describe how you feel....</h4>
                            <p>
                                
                                Here you can add your case description and fill in some essential information like your age and contact number. You can also add up to four pictures to explain your problem more.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-sm-8">
                    <div class="container">

                        <div class="PatientCases">
                            @foreach (var patientCase in Model.PatientCases)
                            {
                                imageUrls = new();
                                req = string.Empty;
                                req = await client.GetStringAsync($"api/get-patient-case-pics/{patientCase.Id}");
                                if (req is not null)
                                {
                                    var options = new JsonSerializerOptions
                        {
                            WriteIndented = true,
                            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                            DictionaryKeyPolicy = JsonNamingPolicy.CamelCase
                        };
                                    imageUrls = JsonSerializer.Deserialize<List<string>>(req, options);
                                }

                                <div class="m-4">
                                    <div class="card">
                                        <div class="row g-0">
                                            <div class="col-sm-5" style="background: #c9cfdf;">
                                                <div id=@("carouselExampleControls"+@counter) class="carousel slide" data-bs-ride="carousel">
                                                    <div class="carousel-inner text-center mt-2">
                                                        @foreach (var image in imageUrls)
                                                        {
                                                            if (image == imageUrls[0])
                                                            {
                                                                <div class="carousel-item active">
                                                                    <img src=@image class="card-img-top" alt="Card image cap" style="height: 293px; max-width:100%" />
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="carousel-item">
                                                                    <img src=@image class="card-img-top" alt="Card image cap" style="height: 293px; max-width:100%" />
                                                                </div>
                                                            }
                                                        }
                                                    </div>
                                                    @if (imageUrls.Count > 1)
                                                    {
                                                        <button class="carousel-control-prev carousel-dark" type="button" data-bs-target=@("#carouselExampleControls" + @counter) data-bs-slide="prev">
                                                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                            <span class="visually-hidden">Previous</span>
                                                        </button>
                                                        <button class="carousel-control-next carousel-dark" type="button" data-bs-target=@("#carouselExampleControls" + @counter) data-bs-slide="next">
                                                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                            <span class="visually-hidden">Next</span>
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                            <div class="col-sm-7" style="background: #c9cfdf;">
                                                <div class="card-body">
                                                    <div class="card-text overflow-hidden">
                                                        
                                                            <div class="setting">
                                                                <div class="dropdown">
                                                                    <button class="dropdown-toggle sett" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                        <i class="bi bi-three-dots-vertical"></i>
                                                                    </button>
                                                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">

                                                                        <!-- Button trigger delete modal -->
                                                                        <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target=@("#DeleteCaseModal" + @counter)>Delete</button></li>

                                                                        <!-- Button trigger edit modal -->
                                                                        <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target=@("#editPatientCaseModal" + @counter)>Edit</button></li>
                                                                    </ul>
                                                                </div>
                                                            </div>

                                                        


                                                        <div class="details">
                                                            <div class="CaseDescription">
                                                                <br><b>Case description: </b>@patientCase.Description
                                                            </div>
                                                            <div class="Age" style="padding:7px 0px 7px 0px;">
                                                                <b>Age: </b>@patientCase.PatientAge
                                                            </div>
                                                            <div class="contactNumb" style="padding:0px 0px 7px 0px;">
                                                                <i class="bi bi-telephone-fill"></i>
                                                                <span style="font-style:normal;"> @patientCase.PatientPhone</span>
                                                            </div>
                                                            <div class="CaseStatus" >
                                                                <b>Status: </b>@patientCase.CaseStatus
                                                            </div>
                                                            
                                                        </div>
                                                    </div>





                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                </div>
                               



                                <!--Delete PatientCaseModal-->

                                <div class="modal fade" id=@("DeleteCaseModal"+@counter) tabindex="-1" aria-labelledby="deleteCaseModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body" style="text-align:center">
                                                Are you sure?
                                                <br />
                                                You won't be able to revert this!
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn mybtn" data-bs-dismiss="modal" style="transform: translate(-175px, 0px); margin: unset; ">Close</button>
                                                <form asp-page-handler="Delete" asp-route-id="@patientCase.Id " method="post">
                                                    <button type="submit" class="btn Dmybtn" style="margin:unset" data-bs-dismiss="modal">Yes, delete it!</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Edit PatientCase Modal -->
                                <div class="modal fade" id=@("editPatientCaseModal"+counter) data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg">
                                        <div class="modal-content" style="top: 79px;">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="staticBackdropLabel" style="color:black">Edit Case</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body modal-lg">
                                                <form method="post" enctype="multipart/form-data" class="align-content-center col-6 w-100 needs-validation" style="margin:auto;text-align:center;color:#1A2238;" novalidate>
                                                    <input name="patientCaseDto.PatientId" value="@patientCase.PatientId" hidden>
                                                    <input name="id" value="@patientCase.Id" hidden>
                                                    <div class="form-floating form-outline mb-1">
                                                        <input name="patientCaseDto.PatientAge" class="form-control" id="floatingPatientAge" placeholder="PatientAge" value="@patientCase.PatientAge" required>
                                                        <label class="form-label" for="floatingPatientAge">Age</label>
                                                        <div class="invalid-feedback">
                                                            Please fill in your age.
                                                        </div>
                                                    </div>
                                                    <div class="form-floating form-outline mb-1">
                                                        <input name="patientCaseDto.PatientPhone" class="form-control" id="floatingPatientPhone" placeholder="PatientPhone" value="@patientCase.PatientPhone" required>
                                                        <label class="form-label" for="floatingPatientPhone">Phone Number</label>
                                                        <div class="invalid-feedback">
                                                            Please fill in your phone number.
                                                        </div>
                                                    </div>
                                                    <div class="form-floating form-outline mb-1">
                                                        <textarea name="patientCaseDto.Description" class="form-control resize" rows="5" id="floatingPatientCaseDescription" placeholder="PatientCaseDesription"
                                                                  style="height:auto;" required>@patientCase.Description</textarea>
                                                        <label class="form-label" for="floatingPatientDescription">Description</label>
                                                        <div class="invalid-feedback">
                                                            Please fill the patient case description.
                                                        </div>
                                                    </div>

                                                    <br>
                                                    <div id=@("carouselEditControls"+counter) class="carousel slide" data-bs-ride="carousel">
                                                        <div class="carousel-inner text-center">
                                                            @foreach (var image in imageUrls)
                                                            {
                                                                <img src=@image alt="..." width="90" height="90" />
                                                            }
                                                            <label>Upload your case pictures</label>
                                                            <input name="patientCaseDto.PatientCasePictures" class="form-control" type="file" multiple>
                                                        </div>
                                                        <button class="carousel-control-prev" type="button" data-bs-target=@("#carouselEditControls" + counter) data-bs-slide="prev">
                                                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                            <span class="visually-hidden">Previous</span>
                                                        </button>
                                                        <button class="carousel-control-next" type="button" data-bs-target=@("#carouselEditControls" + counter) data-bs-slide="next">
                                                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                            <span class="visually-hidden">Next</span>
                                                        </button>
                                                    </div>
                                                    <button asp-page-handler="Edit" type="submit" class="btn mybtn"><i class="bi bi-pencil-square" style="font-style:normal;"> Edit</i></button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                counter++;
                            }

                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}
<section class="addmodel text-center">
    <div class="text-center col-sm addcasebutton">
        <button type="button" class="btn mybtn" data-bs-toggle="modal" data-bs-target="#AddPatientCase">
            <i class="bi bi-plus-circle" style="font-style:normal"> Add Your Case</i>
        </button>
    </div>
    <div class="modal fade" id="AddPatientCase" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel" style="color:black">Enter Your Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-lg">
                    <form method="post" id="createPatientCase" enctype="multipart/form-data"
                          class="align-content-center col-6 w-100 needs-validation" style="margin:auto;color:#1A2238;"
                          novalidate>
                        <div class="form-floating form-outline mb-2">
                            <input name="patientCaseDto.PatientAge" class="form-control" id="floatingPatientAge"
                                   placeholder="PatientAge" required>
                            <label class="form-label" for="floatingPatientAge">PatientAge</label>
                            <div class="invalid-feedback">
                                Please fill Your age.
                            </div>
                        </div>
                        <div class="form-floating form-outline mb-1">
                            <input name="patientCaseDto.PatientPhone" class="form-control" id="floatingPatientPhone"
                                   placeholder="PatientPhone" required>
                            <label class="form-label" for="floatingPatientPhone">Patient Phone</label>
                            <div class="invalid-feedback">
                                Please fill the Your contact number .
                            </div>
                        </div>
                        <div class="form-floating form-outline mb-1">
                            <textarea name="patientCaseDto.Description" class="form-control resize" rows="5"
                                      id="floatingPatientDescription" placeholder="PatientDesription" required></textarea>
                            <label class="form-label" for="floatingPatientDescription">Description</label>
                            <div class="invalid-feedback">
                                Please fill Your Case description.
                            </div>
                        </div>
                        <div class="form-floating form-outline mb-1">
                            <input name="patientCaseDto.PatientCasePictures" class="form-control" type="file"
                                   id="floatingPatientPictures" placeholder="PatientPictures" multiple>
                            <label class="form-label" for="floatingPatientPictures">Upload Case Pictures</label>
                            <div class="invalid-feedback">
                                Please add your case pictures.
                            </div>
                        </div>
                        <div style="text-align:center">
                            <button type="submit" class="btn mybtn btn-block mb-3" style="width:120px;">
                                <i class="bi bi-patch-plus text-center" style="font-style:normal;"> Add</i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

@if (@Model.Msg != null)
{
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    if (@Model.Status == "success")
    {
        <script type="text/javascript">
            Swal.fire({
                icon: 'success',
                title: '@Model.Msg',
                showConfirmButton: false,
                timer: 1500
            })
        </script>
    }
    else if (@Model.Status == "error")
    {
        <script type="text/javascript">
            Swal.fire({
                icon: 'error',
                title: '@Model.Msg',
                showConfirmButton: true
            })
        </script>
    }
}